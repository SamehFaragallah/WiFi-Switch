<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi Controller Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">WiFi Controller Dashboard</h1>
                    <div id="ssh-banner" class="hidden mt-2 text-sm">
                        <span class="bg-yellow-200 text-yellow-800 px-3 py-1 rounded-full font-semibold">
                            ðŸ§ª SSH Test Mode - Commands Not Executed
                        </span>
                    </div>
                </div>
                <a href="#" onclick="handleLogout(); return false;" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-200">
                    Logout
                </a>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- WiFi Status Card -->
            <div class="bg-white rounded-lg shadow-md p-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">WiFi Status</h2>

                <!-- State Indicator -->
                <div class="text-center mb-8">
                    <div id="wifi-status-circle" class="w-32 h-32 rounded-full mx-auto mb-4 flex items-center justify-center transition-all duration-500">
                        <svg id="wifi-icon" class="w-20 h-16" viewBox="0 -5 20 21" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="M7.9795939,11.00003 C7.9795939,12.00002 8.8837256,13 10,13 C11.1162744,13 12.0204061,12.00002 12.0204061,11.00003 C12.0204061,8.00008 7.9795939,8.00008 7.9795939,11.00003 M5.71370846,6.7571 L7.1431458,8.17208 C8.7180523,6.6121 11.2819477,6.6121 12.8568542,8.17208 L14.2862915,6.7571 C11.9183756,4.41413 8.0816244,4.41413 5.71370846,6.7571 M0,1.10019 L1.42842711,2.51516 C6.1551672,-2.16376 13.8448328,-2.16376 18.5715729,2.51516 L20,1.10019 C14.4772199,-4.36673 5.52278008,-4.36673 0,1.10019 M17.1431458,3.92914 L15.7147187,5.34312 C12.5638953,2.22417 7.4361047,2.22417 4.28528134,5.34312 L2.85685423,3.92914 C6.8016971,0.0242 13.1983029,0.0242 17.1431458,3.92914" fill-rule="evenodd"/>
                        </svg>
                    </div>
                    <h3 id="wifi-status-text" class="text-3xl font-bold mb-2">OFF</h3>
                    <p id="wifi-status-subtitle" class="text-gray-600">WiFi is currently disabled</p>
                </div>

                <!-- Toggle Button -->
                <div class="text-center mb-6">
                    <button
                        id="wifi-toggle-btn"
                        onclick="toggleWiFi()"
                        class="px-8 py-4 rounded-lg font-semibold text-white text-lg transition-all duration-200 transform hover:scale-105 shadow-lg"
                    >
                        Turn ON
                    </button>
                </div>

                <!-- Auto-off Countdown -->
                <div id="countdown-container" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                    <p class="text-sm text-gray-600 mb-1">Auto-off in</p>
                    <p id="countdown-display" class="text-2xl font-bold text-blue-600">0h 0m</p>
                </div>
            </div>

            <!-- Settings Card -->
            <div class="bg-white rounded-lg shadow-md p-8">
                <button onclick="toggleSettings()" class="w-full flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Settings</h2>
                    <svg id="settings-arrow" class="w-6 h-6 transform transition-transform" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>

                <div id="settings-panel" class="hidden">
                <!-- Auto-off Duration Setting -->
                <div class="mb-6">
                    <label for="auto-off-duration" class="block text-gray-700 font-semibold mb-2">
                        Auto-off Duration (minutes)
                    </label>
                    <p class="text-sm text-gray-600 mb-3">
                        WiFi will automatically turn off after this duration when turned on.
                    </p>
                    <div class="flex items-center gap-3">
                        <input
                            type="number"
                            id="auto-off-duration"
                            min="1"
                            max="1440"
                            value="180"
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                        <button
                            onclick="updateAutoOffDuration()"
                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200"
                        >
                            Save
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        Current: <span id="current-auto-off-setting">180</span> minutes (3 hours)
                    </p>
                </div>

                <!-- Device Name Setting -->
                <div class="mb-6">
                    <label for="device-name" class="block text-gray-700 font-semibold mb-2">
                        Device Name
                    </label>
                    <p class="text-sm text-gray-600 mb-3">
                        Device name will be prepended to all activity log entries (e.g., "Device Name: Log message").
                    </p>
                    <div class="flex items-center gap-3">
                        <input
                            type="text"
                            id="device-name"
                            placeholder="Enter device name"
                            maxlength="50"
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                        <button
                            onclick="updateDeviceName()"
                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200"
                        >
                            Save
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        Current: <span id="current-device-name">Not set</span>
                    </p>
                </div>

                <!-- LED Brightness Settings -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-3">
                        LED Brightness
                    </label>

                    <!-- Status LED -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-600">Status LED</span>
                            <span id="brightness-status-value" class="text-sm font-semibold text-gray-700">100%</span>
                        </div>
                        <input
                            type="range"
                            id="brightness-status"
                            min="0"
                            max="100"
                            value="100"
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                            oninput="updateLEDBrightnessDisplay('status', this.value)"
                            onchange="updateLEDBrightness('status', this.value)"
                        >
                    </div>

                    <!-- Always On LED -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-600">Always On LED</span>
                            <span id="brightness-always_on-value" class="text-sm font-semibold text-gray-700">100%</span>
                        </div>
                        <input
                            type="range"
                            id="brightness-always_on"
                            min="0"
                            max="100"
                            value="100"
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-green-600"
                            oninput="updateLEDBrightnessDisplay('always_on', this.value)"
                            onchange="updateLEDBrightness('always_on', this.value)"
                        >
                    </div>

                    <!-- Scheduled LED -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-600">Scheduled LED</span>
                            <span id="brightness-scheduled-value" class="text-sm font-semibold text-gray-700">100%</span>
                        </div>
                        <input
                            type="range"
                            id="brightness-scheduled"
                            min="0"
                            max="100"
                            value="100"
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-yellow-600"
                            oninput="updateLEDBrightnessDisplay('scheduled', this.value)"
                            onchange="updateLEDBrightness('scheduled', this.value)"
                        >
                    </div>
                </div>

                <!-- WiFi Schedule -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-3">
                        WiFi Schedule
                    </label>
                    <p class="text-sm text-gray-600 mb-3">
                        Define when WiFi should be scheduled. Scheduled LED is ON when WiFi is in Always On mode, or when within scheduled hours while OFF.
                    </p>

                    <!-- Schedule Entries List -->
                    <div id="schedule-entries" class="space-y-2 mb-4">
                        <p class="text-sm text-gray-500">No schedule entries yet</p>
                    </div>

                    <!-- Add New Schedule Button -->
                    <button
                        onclick="toggleAddScheduleForm()"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200 text-sm"
                    >
                        + Add Schedule Entry
                    </button>

                    <!-- Add Schedule Form (hidden by default) -->
                    <div id="add-schedule-form" class="hidden mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h4 class="font-semibold text-gray-700 mb-3">New Schedule Entry</h4>

                        <!-- Days of Week -->
                        <div class="mb-3">
                            <label class="block text-sm text-gray-600 mb-2">Days</label>
                            <div class="grid grid-cols-7 gap-1">
                                <button type="button" onclick="toggleDay(0)" data-day="0" class="day-btn px-2 py-1 text-xs border border-gray-300 rounded hover:bg-blue-100">Mon</button>
                                <button type="button" onclick="toggleDay(1)" data-day="1" class="day-btn px-2 py-1 text-xs border border-gray-300 rounded hover:bg-blue-100">Tue</button>
                                <button type="button" onclick="toggleDay(2)" data-day="2" class="day-btn px-2 py-1 text-xs border border-gray-300 rounded hover:bg-blue-100">Wed</button>
                                <button type="button" onclick="toggleDay(3)" data-day="3" class="day-btn px-2 py-1 text-xs border border-gray-300 rounded hover:bg-blue-100">Thu</button>
                                <button type="button" onclick="toggleDay(4)" data-day="4" class="day-btn px-2 py-1 text-xs border border-gray-300 rounded hover:bg-blue-100">Fri</button>
                                <button type="button" onclick="toggleDay(5)" data-day="5" class="day-btn px-2 py-1 text-xs border border-gray-300 rounded hover:bg-blue-100">Sat</button>
                                <button type="button" onclick="toggleDay(6)" data-day="6" class="day-btn px-2 py-1 text-xs border border-gray-300 rounded hover:bg-blue-100">Sun</button>
                            </div>
                        </div>

                        <!-- Time Range -->
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">Start Time</label>
                                <input type="time" id="schedule-start-time" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">End Time</label>
                                <input type="time" id="schedule-end-time" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="mb-3">
                            <label class="block text-sm text-gray-600 mb-1">Description (optional)</label>
                            <input type="text" id="schedule-description" placeholder="e.g., Weekday hours" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex gap-2">
                            <button
                                onclick="saveScheduleEntry()"
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 text-sm"
                            >
                                Save
                            </button>
                            <button
                                onclick="toggleAddScheduleForm()"
                                class="flex-1 bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg transition duration-200 text-sm"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>

                <!-- SSH Status -->
                <div class="mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div class="flex items-center gap-2">
                        <div id="ssh-indicator" class="w-3 h-3 rounded-full bg-green-500"></div>
                        <span id="ssh-status" class="text-sm font-semibold">SSH Enabled</span>
                    </div>
                    <p class="text-xs text-gray-600 mt-1">Set 'ssh.enabled' to False in config.py to disable for testing</p>
                </div>
                </div>

                <!-- Connection Status -->
                <div class="border-t pt-6">
                    <h3 class="font-semibold text-gray-700 mb-3">Connection Status</h3>
                    <div class="flex items-center gap-2">
                        <div id="connection-indicator" class="w-3 h-3 rounded-full bg-gray-400"></div>
                        <span id="connection-status" class="text-sm text-gray-600">Connecting...</span>
                    </div>
                </div>

                <!-- Last Update -->
                <div class="mt-4">
                    <p class="text-xs text-gray-500">
                        Last update: <span id="last-update">--</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Activity Log</h2>
            <div id="activity-log" class="space-y-2 max-h-64 overflow-y-auto">
                <p class="text-gray-500 text-sm">Waiting for events...</p>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // Initialize socket connection
        const socket = io();

        let currentWiFiState = false;
        let countdownInterval = null;
        let isInitialLoad = true;

        // Handle logout
        function handleLogout() {
            window.location.href = '/logout';
        }

        // Connection status
        socket.on('connect', () => {
            console.log('Connected to server');
            updateConnectionStatus(true);
            socket.emit('get_current_state');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            updateConnectionStatus(false);
        });

        // Current settings (no toast)
        socket.on('current_settings', (data) => {
            console.log('Current settings:', data);
            const durationInput = document.getElementById('auto-off-duration');
            const currentSetting = document.getElementById('current-auto-off-setting');
            const deviceNameInput = document.getElementById('device-name');
            const currentDeviceName = document.getElementById('current-device-name');

            if (durationInput) durationInput.value = data.auto_off_duration_minutes;

            if (currentSetting) {
                const hours = Math.floor(data.auto_off_duration_minutes / 60);
                const minutes = data.auto_off_duration_minutes % 60;
                let timeText = '';
                if (hours > 0) timeText += `${hours} hour${hours > 1 ? 's' : ''}`;
                if (minutes > 0) timeText += `${hours > 0 ? ' ' : ''}${minutes} minute${minutes > 1 ? 's' : ''}`;

                // Update the span content, not the parent
                currentSetting.textContent = `${data.auto_off_duration_minutes} minutes (${timeText})`;
            }

            // Update device name
            if (deviceNameInput) {
                deviceNameInput.value = data.device_name || '';
            }
            if (currentDeviceName) {
                currentDeviceName.textContent = data.device_name || 'Not set';
            }

            // Update SSH status
            const sshIndicator = document.getElementById('ssh-indicator');
            const sshStatus = document.getElementById('ssh-status');
            const sshBanner = document.getElementById('ssh-banner');

            if (sshIndicator && sshStatus && sshBanner) {
                if (data.ssh_enabled) {
                    sshIndicator.classList.remove('bg-gray-400');
                    sshIndicator.classList.add('bg-green-500');
                    sshStatus.textContent = 'SSH Enabled';
                    sshBanner.classList.add('hidden');
                } else {
                    sshIndicator.classList.remove('bg-green-500');
                    sshIndicator.classList.add('bg-gray-400');
                    sshStatus.textContent = 'SSH Disabled (Test Mode)';
                    sshBanner.classList.remove('hidden');
                }
            }

            isInitialLoad = false;
        });

        // Activity log history (on connect)
        socket.on('activity_log_history', (data) => {
            console.log('Activity log history received:', data);
            const logContainer = document.getElementById('activity-log');
            logContainer.innerHTML = ''; // Clear placeholder

            if (data.entries && data.entries.length > 0) {
                // Display entries in reverse order (newest first)
                data.entries.reverse().forEach(entry => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'flex items-start gap-2 text-sm p-2 rounded';
                    const time = new Date(entry.timestamp).toLocaleTimeString();
                    entryDiv.innerHTML = `
                        <span class="text-gray-400">${time}</span>
                        <span class="text-gray-600">${entry.message}</span>
                    `;
                    logContainer.appendChild(entryDiv);
                });
            } else {
                logContainer.innerHTML = '<p class="text-gray-500 text-sm">No activity yet...</p>';
            }
        });

        // Activity log new entry (broadcast to all clients)
        socket.on('activity_log_entry', (entry) => {
            console.log('New activity log entry:', entry);
            const logContainer = document.getElementById('activity-log');

            // Clear placeholder if exists
            if (logContainer.querySelector('.text-gray-500')) {
                logContainer.innerHTML = '';
            }

            const entryDiv = document.createElement('div');
            entryDiv.className = 'flex items-start gap-2 text-sm p-2 rounded';
            const time = new Date(entry.timestamp).toLocaleTimeString();
            entryDiv.innerHTML = `
                <span class="text-gray-400">${time}</span>
                <span class="text-gray-600">${entry.message}</span>
            `;

            // Insert at top (newest first)
            logContainer.insertBefore(entryDiv, logContainer.firstChild);

            // Keep only last 25 entries
            while (logContainer.children.length > 25) {
                logContainer.removeChild(logContainer.lastChild);
            }
        });

        // WiFi state changed
        socket.on('wifi_state_changed', (data) => {
            console.log('WiFi state changed:', data);
            currentWiFiState = data.state;
            updateWiFiDisplay(data.state);
            updateLastUpdate();

            // Show toast for real actions (not initial/query loads)
            if (data.source !== 'initial' && data.source !== 'query') {
                showToast(`WiFi ${data.state ? 'ON' : 'OFF'}`, data.state ? 'success' : 'info');
            }
        });

        // Auto-off countdown
        socket.on('auto_off_countdown', (data) => {
            console.log('Countdown update:', data);
            updateCountdownDisplay(data.remaining_minutes);
        });

        // Auto-off triggered
        socket.on('auto_off_triggered', (data) => {
            console.log('Auto-off triggered');
            showToast('WiFi automatically turned OFF (timer expired)', 'warning');
        });

        // Settings updated
        socket.on('settings_updated', (data) => {
            console.log('Settings updated:', data);
            
            // Update auto-off duration if provided
            if (data.auto_off_duration_minutes !== undefined) {
                const currentSetting = document.getElementById('current-auto-off-setting');
                if (currentSetting) {
                    const hours = Math.floor(data.auto_off_duration_minutes / 60);
                    const minutes = data.auto_off_duration_minutes % 60;
                    let timeText = '';
                    if (hours > 0) timeText += `${hours} hour${hours > 1 ? 's' : ''}`;
                    if (minutes > 0) timeText += `${hours > 0 ? ' ' : ''}${minutes} minute${minutes > 1 ? 's' : ''}`;

                    currentSetting.textContent = `${data.auto_off_duration_minutes} minutes (${timeText})`;
                }
                showToast(`Settings saved: ${data.auto_off_duration_minutes} minutes`, 'success');
            }
            
            // Update device name if provided
            if (data.device_name !== undefined) {
                const currentDeviceName = document.getElementById('current-device-name');
                if (currentDeviceName) {
                    currentDeviceName.textContent = data.device_name || 'Not set';
                }
                const deviceNameInput = document.getElementById('device-name');
                if (deviceNameInput) {
                    deviceNameInput.value = data.device_name || '';
                }
                showToast(`Device name saved: ${data.device_name || 'cleared'}`, 'success');
            }
        });

        // SSH errors
        socket.on('ssh_error', (data) => {
            console.error('SSH error:', data);
            showToast(`Error: ${data.error}`, 'error');
            addActivityLog(`Error: ${data.error}`, 'error');
        });

        // Toggle WiFi
        function toggleWiFi() {
            const newState = !currentWiFiState;
            console.log('Toggling WiFi to:', newState);
            socket.emit('toggle_wifi', { desired_state: newState });
        }

        // Toggle settings panel
        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            const arrow = document.getElementById('settings-arrow');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                arrow.classList.add('rotate-180');
            } else {
                panel.classList.add('hidden');
                arrow.classList.remove('rotate-180');
            }
        }

        // Update auto-off duration
        function updateAutoOffDuration() {
            const duration = parseInt(document.getElementById('auto-off-duration').value);
            if (duration < 1 || duration > 1440) {
                showToast('Duration must be between 1 and 1440 minutes', 'error');
                return;
            }
            console.log('Updating auto-off duration to:', duration);
            socket.emit('update_auto_off_duration', { duration_minutes: duration });
        }

        // Update device name
        function updateDeviceName() {
            const deviceName = document.getElementById('device-name').value.trim();
            if (deviceName.length > 50) {
                showToast('Device name must be 50 characters or less', 'error');
                return;
            }
            console.log('Updating device name to:', deviceName);
            socket.emit('update_device_name', { device_name: deviceName });
        }

        // Update LED brightness display (instant feedback)
        function updateLEDBrightnessDisplay(ledName, brightness) {
            const valueSpan = document.getElementById(`brightness-${ledName}-value`);
            if (valueSpan) {
                valueSpan.textContent = `${brightness}%`;
            }
        }

        // Update LED brightness (send to server)
        function updateLEDBrightness(ledName, brightness) {
            console.log(`Updating LED brightness: ${ledName} = ${brightness}%`);
            socket.emit('update_led_brightness', {
                led: ledName,
                brightness: parseInt(brightness)
            });
        }

        // LED brightness settings received
        socket.on('led_brightness_settings', (data) => {
            console.log('LED brightness settings:', data);
            if (data.brightness) {
                // Update sliders and display values
                Object.keys(data.brightness).forEach(ledName => {
                    const slider = document.getElementById(`brightness-${ledName}`);
                    const valueSpan = document.getElementById(`brightness-${ledName}-value`);
                    if (slider && valueSpan) {
                        slider.value = data.brightness[ledName];
                        valueSpan.textContent = `${data.brightness[ledName]}%`;
                    }
                });
            }
        });

        // LED brightness updated (broadcast to all clients)
        socket.on('led_brightness_updated', (data) => {
            console.log('LED brightness updated:', data);
            if (data.led && data.brightness !== undefined) {
                const slider = document.getElementById(`brightness-${data.led}`);
                const valueSpan = document.getElementById(`brightness-${data.led}-value`);
                if (slider && valueSpan) {
                    slider.value = data.brightness;
                    valueSpan.textContent = `${data.brightness}%`;
                }
                showToast(`${data.led.replace('_', ' ')} LED brightness: ${data.brightness}%`, 'success');
            }
        });

        // Schedule management
        let selectedDays = new Set();

        function toggleAddScheduleForm() {
            const form = document.getElementById('add-schedule-form');
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                // Reset form
                selectedDays.clear();
                document.querySelectorAll('.day-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-500', 'text-white');
                });
                document.getElementById('schedule-start-time').value = '';
                document.getElementById('schedule-end-time').value = '';
                document.getElementById('schedule-description').value = '';
            } else {
                form.classList.add('hidden');
            }
        }

        function toggleDay(day) {
            const dayBtn = document.querySelector(`[data-day="${day}"]`);
            if (selectedDays.has(day)) {
                selectedDays.delete(day);
                dayBtn.classList.remove('bg-blue-500', 'text-white');
            } else {
                selectedDays.add(day);
                dayBtn.classList.add('bg-blue-500', 'text-white');
            }
        }

        function saveScheduleEntry() {
            const startTime = document.getElementById('schedule-start-time').value;
            const endTime = document.getElementById('schedule-end-time').value;
            const description = document.getElementById('schedule-description').value.trim();

            if (selectedDays.size === 0) {
                showToast('Please select at least one day', 'error');
                return;
            }

            if (!startTime || !endTime) {
                showToast('Please enter start and end times', 'error');
                return;
            }

            console.log('Adding schedule entry:', {
                days: Array.from(selectedDays),
                start_time: startTime,
                end_time: endTime,
                description: description
            });

            socket.emit('add_schedule_entry', {
                days: Array.from(selectedDays),
                start_time: startTime,
                end_time: endTime,
                description: description
            });

            toggleAddScheduleForm();
        }

        function removeScheduleEntry(entryId) {
            if (confirm('Are you sure you want to delete this schedule entry?')) {
                console.log('Removing schedule entry:', entryId);
                socket.emit('remove_schedule_entry', { id: entryId });
            }
        }

        function renderScheduleEntries(entries) {
            const container = document.getElementById('schedule-entries');

            if (!entries || entries.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">No schedule entries yet</p>';
                return;
            }

            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

            container.innerHTML = entries.map(entry => {
                const daysText = entry.days.sort((a, b) => a - b).map(d => dayNames[d]).join(', ');
                const description = entry.description ? `<br><span class="text-xs text-gray-500">${entry.description}</span>` : '';

                return `
                    <div class="p-3 bg-white border border-gray-200 rounded-lg">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="text-sm font-semibold text-gray-700">${daysText}</div>
                                <div class="text-sm text-gray-600">${entry.start_time} - ${entry.end_time}</div>
                                ${description}
                            </div>
                            <button
                                onclick="removeScheduleEntry('${entry.id}')"
                                class="text-red-500 hover:text-red-700 text-sm font-semibold ml-2"
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Schedule updated (from server)
        socket.on('schedule_updated', (data) => {
            console.log('Schedule updated:', data);
            if (data.entries) {
                renderScheduleEntries(data.entries);
            }
        });

        // Update WiFi display
        function updateWiFiDisplay(state) {
            const circle = document.getElementById('wifi-status-circle');
            const text = document.getElementById('wifi-status-text');
            const subtitle = document.getElementById('wifi-status-subtitle');
            const button = document.getElementById('wifi-toggle-btn');
            const countdownContainer = document.getElementById('countdown-container');

            if (state) {
                // WiFi ON
                circle.classList.remove('bg-gray-300');
                circle.classList.add('bg-green-500');
                text.textContent = 'ON';
                text.classList.remove('text-gray-700');
                text.classList.add('text-green-600');
                subtitle.textContent = 'WiFi is currently enabled';
                button.textContent = 'Turn OFF';
                button.classList.remove('bg-green-600', 'hover:bg-green-700');
                button.classList.add('bg-red-600', 'hover:bg-red-700');
                countdownContainer.classList.remove('hidden');
            } else {
                // WiFi OFF
                circle.classList.remove('bg-green-500');
                circle.classList.add('bg-gray-300');
                text.textContent = 'OFF';
                text.classList.remove('text-green-600');
                text.classList.add('text-gray-700');
                subtitle.textContent = 'WiFi is currently disabled';
                button.textContent = 'Turn ON';
                button.classList.remove('bg-red-600', 'hover:bg-red-700');
                button.classList.add('bg-green-600', 'hover:bg-green-700');
                countdownContainer.classList.add('hidden');
            }
        }

        // Update countdown display
        function updateCountdownDisplay(remainingMinutes) {
            const hours = Math.floor(remainingMinutes / 60);
            const minutes = remainingMinutes % 60;
            document.getElementById('countdown-display').textContent = `${hours}h ${minutes}m`;
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connection-indicator');
            const status = document.getElementById('connection-status');

            if (connected) {
                indicator.classList.remove('bg-gray-400');
                indicator.classList.add('bg-green-500');
                status.textContent = 'Connected';
                status.classList.remove('text-gray-600');
                status.classList.add('text-green-600');
            } else {
                indicator.classList.remove('bg-green-500');
                indicator.classList.add('bg-red-500');
                status.textContent = 'Disconnected';
                status.classList.remove('text-green-600');
                status.classList.add('text-red-600');
            }
        }

        // Update last update time
        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleTimeString();
        }

        // Add activity log entry
        function addActivityLog(message, type = 'info') {
            const logContainer = document.getElementById('activity-log');
            const entry = document.createElement('div');
            entry.className = 'flex items-start gap-2 text-sm p-2 rounded';

            const time = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-600';

            entry.innerHTML = `
                <span class="text-gray-400">${time}</span>
                <span class="${colorClass}">${message}</span>
            `;

            // Clear placeholder if exists
            if (logContainer.querySelector('.text-gray-500')) {
                logContainer.innerHTML = '';
            }

            logContainer.insertBefore(entry, logContainer.firstChild);

            // Keep only last 20 entries
            while (logContainer.children.length > 20) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');

            const bgColors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };

            toast.className = `${bgColors[type] || bgColors.info} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
            toast.textContent = message;

            toastContainer.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 10);

            // Remove after 4 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    toastContainer.removeChild(toast);
                }, 300);
            }, 4000);
        }
    </script>
</body>
</html>
